#cloud-config
# Cloud-init template for Lambda Labs GPU instances
# Configures persistent storage and Nix package manager
package_update: true
package_upgrade: false

write_files:
  - path: /etc/profile.d/nix-daemon.sh
    permissions: '0644'
    owner: root:root
    content: |
      if [ -e /nix/var/nix/profiles/default/etc/profile.d/nix-daemon.sh ]; then
        . /nix/var/nix/profiles/default/etc/profile.d/nix-daemon.sh
      fi

runcmd:
  - |
    #!/bin/bash
    set -ux

    {% if filesystem_name %}
    # Setup persistent filesystem structure
    FS_MOUNT="{{ filesystem_mount }}"
    mkdir -p "$FS_MOUNT"

    # Create loop-mounted disk image for /nix (persistent with xattr support)
    NIX_IMG="$FS_MOUNT/nix.img"
    if [ ! -f "$NIX_IMG" ]; then
      echo "Creating 100GB sparse disk image for Nix store..."
      truncate -s 100G "$NIX_IMG"
      mkfs.ext4 -F "$NIX_IMG"
    fi

    # Mount the disk image at /nix
    if ! mountpoint -q /nix; then
      mkdir -p /nix
      mount -o loop "$NIX_IMG" /nix || true
    fi
    if ! grep -q "$NIX_IMG /nix " /etc/fstab; then
      echo "$NIX_IMG /nix ext4 loop 0 0" >> /etc/fstab
    fi

    # Bind mount /home/ubuntu to persistent storage (for user data)
    mkdir -p "$FS_MOUNT/ubuntu"
    if ! mountpoint -q /home/{{ ssh_username }}; then
      # On first use: copy system-generated home directory to NFS if NFS location is empty
      if [ -z "$(ls -A $FS_MOUNT/ubuntu)" ]; then
        echo "First use: copying initial home directory to persistent storage..."
        cp -a /home/{{ ssh_username }}/. "$FS_MOUNT/ubuntu/"
      fi

      # Bind mount the persistent home directory
      # Note: Not added to fstab because systemd misinterprets it as NFS submount
      mount --bind "$FS_MOUNT/ubuntu" /home/{{ ssh_username }}
    fi
    {% endif %}

    # Install Nix using Determinate Systems installer (better for automation)
    if ! command -v nix >/dev/null 2>&1; then
      curl -L https://install.determinate.systems/nix | sh -s -- install --no-confirm
    fi

    # Ensure nix profile is loaded in future shells
    if ! grep -q 'nix-daemon.sh' /etc/bash.bashrc; then
      echo '. /etc/profile.d/nix-daemon.sh' >> /etc/bash.bashrc
    fi

    # Quick smoke test
    . /etc/profile.d/nix-daemon.sh || true
    nix --version || true

    echo "Cloud-init complete: Nix installed{% if filesystem_name %}, persistent /nix and /home at {{ filesystem_mount }}{% endif %}"
